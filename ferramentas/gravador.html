<!DOCTYPE html>

<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant-Agente</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background-color: #111;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
        }
        .container {
            background-color: #1e90ff;
            padding: 30px;
            border-radius: 10px;
            width: 400px;
            margin: 20px auto;
            position: relative;
        }
        button {
            background-color: #000;
            color: white;
            border: none;
            padding: 10px;
            margin: 10px 0;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
        }
        .configuracao {
            background-color: #222;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            margin: 0 auto;
            text-align: left;
        }
        .configuracao h2 {
            margin-top: 0;
            display: inline-block;
        }
        #apiKeyInput, #tempoParadaInput {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: none;
        }
        .configuracao button {
            width: 100%;
        }
        #fileInput {
            display: none;
        }
        #status {
            margin-top: 15px;
            background: #0009;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            color: #0f0;
        }
        .config-toggle {
            cursor: pointer;
            float: right;
            font-size: 18px;
        }
        #configBody {
            display: none;
        }
        .config-item {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<h1 style="color: white;">Assistant-Agente</h1>

<div class="container">
    <button id="btnGravar" onclick="gravarAudio()">Gravar √Åudio</button>
    <button onclick="enviarAudioGravado()">Enviar √Åudio Gravado</button>
    <button onclick="document.getElementById('fileInput').click()">Enviar √Åudio da M√°quina</button>
    <button onclick="verTranscricao()">Ver Transcri√ß√µes</button>
    <button onclick="verHistorico()">Ver Hist√≥rico</button>
    <button onclick="mostrarStatus('Funcionalidade n√£o implementada.')">Sincronizar Arquivos</button>
    <input type="file" id="fileInput" accept="audio/*" onchange="enviarAudioLocal(event)">
    <div id="status">Pronto</div>
</div>

<div class="configuracao">
    <h2>Configura√ß√£o</h2>
    <span class="config-toggle" onclick="toggleConfig()">‚ñº</span>
    <div id="configBody">
        <div class="config-item">
            <label for="apiKeyInput" id="apiLabel">API Key:</label>
            <input type="password" id="apiKeyInput" placeholder="Digite sua API Key">
        </div>
        <div class="config-item">
            <button id="btnApiKey" onclick="alternarApiKey()">Salvar API</button>
        </div>
        <div class="config-item">
            <input type="checkbox" id="pararAutoCheckbox">
            <label for="pararAutoCheckbox">Parar grava√ß√£o automaticamente</label>
        </div>
        <div class="config-item">
            <input type="number" id="tempoParadaInput" placeholder="Tempo em segundos" min="1">
        </div>
    </div>
</div>

<script>
    let mediaRecorder;
    let audioChunks = [];
    let ultimaTranscricao = "";
    let historicoTranscricoes = [];
    let toggle = false;
    let intervaloStatus;
    let paradaTimeout;

    window.onload = () => {
        const apiKey = localStorage.getItem("openai_api_key");
        if (apiKey) {
            document.getElementById("apiKeyInput").placeholder = "API Key salva";
            document.getElementById("btnApiKey").textContent = "Apagar API";
        }

        const historicoSalvo = localStorage.getItem("historico_transcricoes");
        if (historicoSalvo) {
            historicoTranscricoes = JSON.parse(historicoSalvo);
        }
    };

    function mostrarStatus(msg, erro = false) {
        const el = document.getElementById("status");
        el.textContent = msg;
        el.style.color = erro ? "#f55" : "#0f0";

        setTimeout(() => {
            el.textContent = "Pronto";
            el.style.color = "#0f0";
        }, 15000);
    }

    function toggleConfig() {
        const configBody = document.getElementById("configBody");
        configBody.style.display = configBody.style.display === "none" ? "block" : "none";
    }

    function alternarApiKey() {
        const apiKey = localStorage.getItem("openai_api_key");
        if (apiKey) {
            localStorage.removeItem("openai_api_key");
            document.getElementById("btnApiKey").textContent = "Salvar API";
            document.getElementById("apiKeyInput").value = "";
            document.getElementById("apiKeyInput").placeholder = "Digite sua API Key";
            mostrarStatus("API Key removida.");
        } else {
            const novaKey = document.getElementById("apiKeyInput").value;
            if (!novaKey) {
                mostrarStatus("Por favor, insira a API Key.", true);
                return;
            }
            localStorage.setItem("openai_api_key", novaKey);
            document.getElementById("btnApiKey").textContent = "Apagar API";
            document.getElementById("apiKeyInput").value = "";
            document.getElementById("apiKeyInput").placeholder = "API Key salva";
            mostrarStatus("API Key salva com sucesso!");
        }
    }

    function alternarMensagemGravacao() {
        const el = document.getElementById("status");
        intervaloStatus = setInterval(() => {
            el.textContent = toggle ? "üéôÔ∏è Gravando..." : "üëÇ Escutando...";
            toggle = !toggle;
        }, 1000);
    }

    function pararMensagemGravacao() {
        clearInterval(intervaloStatus);
    }

    async function gravarAudio() {
        const btn = document.getElementById("btnGravar");

        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);

                mediaRecorder.onstop = () => {
                    pararMensagemGravacao();
                    clearTimeout(paradaTimeout);
                    mostrarStatus("üî¥ Grava√ß√£o finalizada e pronta para envio");
                    btn.textContent = "Gravar √Åudio";
                };

                mediaRecorder.start();
                btn.textContent = "üî¥ Parar Grava√ß√£o";
                alternarMensagemGravacao();

                if (document.getElementById("pararAutoCheckbox").checked) {
                    const tempo = parseInt(document.getElementById("tempoParadaInput").value);
                    if (!isNaN(tempo) && tempo > 0) {
                        paradaTimeout = setTimeout(() => {
                            mediaRecorder.stop();
                        }, tempo * 1000);
                    }
                }

            } catch (error) {
                mostrarStatus("Erro ao acessar o microfone.", true);
                console.error(error);
            }
        } else {
            mediaRecorder.stop();
        }
    }

    async function enviarAudioGravado() {
        if (audioChunks.length === 0) {
            mostrarStatus("Nenhum √°udio gravado dispon√≠vel.", true);
            return;
        }
        const blob = new Blob(audioChunks, { type: "audio/webm" });
        await transcreverAudio(blob);
    }

    async function enviarAudioLocal(event) {
        const file = event.target.files[0];
        if (file) {
            await transcreverAudio(file);
        }
    }

    async function transcreverAudio(audioBlob) {
        const apiKey = localStorage.getItem("openai_api_key");
        if (!apiKey) {
            mostrarStatus("API Key n√£o encontrada. Salve sua chave primeiro.", true);
            return;
        }

        const formData = new FormData();
        const correctedBlob = new Blob([audioBlob], { type: "audio/webm" });
        formData.append("file", correctedBlob, "audio.webm");
        formData.append("model", "whisper-1");

        mostrarStatus("‚è≥ Enviando √°udio para transcri√ß√£o...");

        try {
            const response = await fetch("https://api.openai.com/v1/audio/transcriptions", {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${apiKey}`
                },
                body: formData
            });

            const result = await response.json();
            if (result.text) {
                ultimaTranscricao = result.text;
                historicoTranscricoes.push({ texto: result.text, data: new Date().toLocaleString() });
                localStorage.setItem("historico_transcricoes", JSON.stringify(historicoTranscricoes));
                mostrarStatus("‚úÖ Transcri√ß√£o conclu√≠da!");
            } else {
                mostrarStatus("Erro na transcri√ß√£o.", true);
                console.log(result);
            }
        } catch (error) {
            mostrarStatus("Erro ao transcrever √°udio.", true);
            console.error(error);
        }
    }

    function verTranscricao() {
        if (!ultimaTranscricao) {
            mostrarStatus("Nenhuma transcri√ß√£o dispon√≠vel ainda.", true);
            return;
        }
        const novaAba = window.open();
        novaAba.document.write(`<!DOCTYPE html><html><head><title>Transcri√ß√£o</title></head><body style='background:#111;color:white;font-family:sans-serif;padding:20px;'><h2>Transcri√ß√£o</h2><p>${ultimaTranscricao}</p></body></html>`);
    }

    function verHistorico() {
        if (historicoTranscricoes.length === 0) {
            mostrarStatus("Nenhuma transcri√ß√£o no hist√≥rico.", true);
            return;
        }
        const novaAba = window.open();
        let html = "<!DOCTYPE html><html><head><title>Hist√≥rico de Transcri√ß√µes</title></head><body style='background:#111;color:white;font-family:sans-serif;padding:20px;'><h2>Hist√≥rico de Transcri√ß√µes</h2>";
        historicoTranscricoes.forEach(item => {
            html += `<div style='margin-bottom:20px;'><strong>${item.data}</strong><p>${item.texto}</p></div>`;
        });
        html += "</body></html>";
        novaAba.document.write(html);
    }
</script>

</body>
</html>